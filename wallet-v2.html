<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêï Dogecoin Testnet Wallet V2</title>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        function initDeps() {
            return new Promise((resolve, reject) => {
                const loadScript = (src) => {
                    return new Promise((resolve, reject) => {
                        console.log('Loading script:', src);
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = () => {
                            console.log('Successfully loaded:', src);
                            resolve();
                        };
                        script.onerror = (error) => {
                            console.error('Failed to load script:', src, error);
                            reject(new Error('Failed to load ' + src));
                        };
                        document.head.appendChild(script);
                    });
                };

                Promise.all([
                    loadScript('crypto-libs.js'),
                    loadScript('https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js')
                ]).then(() => {
                    if (window.bs58 && window.elliptic) {
                        console.log('All dependencies loaded successfully');
                        window.initComplete = true;
                        resolve();
                    } else {
                        reject(new Error('crypto-libs.js not loaded properly'));
                    }
                }).catch(error => {
                    console.error('Failed to load dependencies:', error);
                    reject(error);
                });
            });
        }
        window.initDeps = initDeps;
    </script>
    <script type="module" src="js/app.js"></script>
</head>

<body>
    <div class="container">
        <h1>üêï Dogecoin Testnet Wallet V2</h1>

        <div class="main-grid">
            <!-- Left Column: Wallet Info and Transaction History -->
            <div class="left-column">
                <div class="section">
                    <h2>Wallet Information</h2>
                    <div class="form-group">
                        <label>Network:</label>
                        <div class="info-display">Dogecoin Testnet</div>
                    </div>
                    <div class="form-group">
                        <select id="walletSelect" onchange="">
                            <option value="">Select or Create Wallet</option>
                        </select>
                        <div class="wallet-controls">
                            <button id="generateWalletBtn">Generate New Wallet</button>
                            <button id="newWalletBtn" style="display: none;">Test newWallet</button>
                            <button id="importWalletBtn">Import Wallet</button>
                            <button id="deleteWalletBtn" class="delete-btn">Delete</button>
                        </div>
                        <div class="form-group">
                            <input type="text" id="importPrivateKey" placeholder="Enter private key (WIF format) then click Import Wallet">
                        </div>
                    </div>
                    <div class="form-group" style="display: none;">
                        <label>Query Method:</label>
                        <div>
                            <label class="inline-label">
                                <input type="radio" name="queryMethod" value="electrs" checked
                                    onchange="switchQueryMethod()"> Electrs API
                            </label>
                            <label class="inline-label">
                                <input type="radio" name="queryMethod" value="rpc" onchange="switchQueryMethod()"> Local RPC
                            </label>
                        </div>
                        <div id="electrsOptions">
                            <label class="inline-label">
                                <input type="checkbox" id="useProxy" onchange="toggleElectrsProxy()"> Use Proxy
                            </label>
                            <span class="help-text">(Local environment uses CORS proxy)</span>
                        </div>
                        <div class="flex-container">
                            <div class="info-display" id="rpcStatus">Detecting connection...</div>
                            <button id="testConnectionBtn" class="copy-btn">Test</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address:</label>
                        <div class="address-container">
                            <span class="address" id="address">Click Generate Wallet to get address</span>
                            <button id="copyAddressBtn" class="copy-btn" disabled>Copy</button>
                            <button id="viewInBrowser" class="browser-link" disabled>View in Browser</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Private Key (WIF):</label>
                        <div class="address-container">
                            <div class="address" id="privateKey">Click Generate Wallet to get private key</div>
                            <button id="copyPrivateKeyBtn" class="copy-btn" disabled>Copy</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Balance:</label>
                        <div class="balance-container">
                            <div class="balance" id="balance">0.00000000 DOGE</div>
                            <button id="refreshBalanceBtn" class="copy-btn">Refresh Balance</button>
                            <div class="auto-refresh-status">
                                <!-- Auto refresh status will be populated by JS -->
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="faucet-info">
                            <strong>Testnet Faucet:</strong>
                            <a href="https://faucet.doge.toys/" target="_blank" class="faucet-link">üö∞ Get Free Test Coins</a>
                        </div>
                    </div>
                </div>
                <!-- Network Status will now be here, under Wallet Info -->
                <div class="section">
                    <div class="section network-status-section">
                        <h2>Network Status</h2>
                        <div class="network-hash-display">
                            <label>Current Block Hash:</label> <span id="currentBlockHash" class="hash-display">Loading...</span>
                        </div>
                        <div class="info-grid">
                            <div>
                                <label>Current Block Height:</label> <span id="currentBlockHeight">Loading...</span>
                            </div>
                            <div>
                                <label>Block Time:</label> <span id="currentBlockTime">Loading...</span>
                            </div>
                            <div>
                                <label>Difficulty:</label> <span id="currentBlockDifficulty">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Send Transaction and Transaction History -->
            <div class="right-column">
                <div class="section">
                    <h2>Send Transaction</h2>
                    <div class="form-group horizontal">
                        <label>Recipient Address:</label>
                        <input type="text" id="toAddress" placeholder="Enter recipient address"
                            value="">
                    </div>
                    <div class="form-group horizontal">
                        <label>L2Scan Fee Address:</label>
                        <input type="text" id="l2scanFeeAddress" placeholder="Enter L2Scan fee address"
                            value="">
                    </div>
                    <div class="form-group horizontal">
                        <label>Amount (DOGE):</label>
                        <input type="number" id="amount" step="0.00000001" placeholder="Send amount">
                    </div>
                    <div class="form-group horizontal">
                        <label>Fee (DOGE):</label>
                        <div class="fee-input-group">
                            <input type="number" id="fee" value="0.2" step="0.1" placeholder="Manual input or calculate">
                            <button id="calculateFeeBtn" class="copy-btn" style="margin-left: 8px;">Estimate Fee</button>
                            
                            <span id="estimatedFee" class="info-display"
                                style="padding: 4px 8px; font-size: 12px; flex-grow: 1; text-align: right;">0.00000000
                                DOGE</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>OP_RETURN Data (Optional):</label>
                        <div class="op-return-format">
                            <div class="op-return-options">
                                <label>
                                    <input type="radio" name="opReturnFormat" id="opReturnFormatString" value="string" checked> String
                                </label>
                                <label>
                                    <input type="radio" name="opReturnFormat" id="opReturnFormatHex" value="hex"> Hexadecimal
                                </label>
                            </div>
                            <select id="opReturnFormat" style="display: none;">
                                <option value="string">String</option>
                                <option value="hex">Hexadecimal</option>
                            </select>
                        </div>
                        <textarea id="opReturnData" rows="3"
                            placeholder="Enter data content&#10;String mode: Hello Dogecoin!&#10;Hexadecimal mode: 48656c6c6f20446f6765636f696e21&#10;Maximum 80 bytes"></textarea>
                        <small id="opReturnHelp">OP_RETURN allows including arbitrary data in transactions, permanently recorded on blockchain</small>
                    </div>
                    <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                        <button id="sendTransactionBtn" style="flex: 1;">Send Transaction</button>
                    </div>
                </div>
                <!-- Transaction History moved here, under Send Transaction -->
                <div class="section">
                    <h2>Transaction History</h2>
                    <div class="transaction-lists">
                        <div class="pending-transactions">
                            <h3>Pending Transactions</h3>
                            <div class="transaction-list" id="pendingTransactions">
                                <div class="no-transactions">No pending transactions</div>
                            </div>
                        </div>
                        <div class="broadcasted-transactions">
                            <h3>Processed Transactions (Local Cache)</h3>
                            <table class="transaction-table" id="broadcastedTransactionsTable">
                                <thead>
                                    <tr>
                                        <th>TXID</th>
                                        <th>Amount (DOGE)</th>
                                        <th>Recipient</th>
                                        <th>Status</th>
                                        <th>Block</th>
                                        <th>Confirmation Time</th>
                                    </tr>
                                </thead>
                                <tbody id="broadcastedTransactions"></tbody>
                            </table>
                            <div id="noBroadcastedTransactions" class="no-transactions" style="display: none;">No processed transactions
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="footer-info">
            <p>‚ö†Ô∏è This is a testnet wallet for development and testing purposes only</p>
            <p>Do not use on mainnet, keep your private keys secure</p>
            <p>üí° Supports complete wallet functionality: generation, import, balance query, transaction sending</p>
            <p>üîß Local environment automatically uses CORS proxy to solve cross-origin issues</p>
            <p>üí∞ Get test coins: <a href="https://faucet.doge.toys/" target="_blank">faucet.doge.toys</a></p>
        </div>
    </div>

    <div id="alerts" class="alert-container"></div>

    <script type="module" src="js/blockInfo.js"></script>
</body>

</html>
